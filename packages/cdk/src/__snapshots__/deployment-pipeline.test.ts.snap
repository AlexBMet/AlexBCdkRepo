// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`[deployment-pipeline.ts] unit tests [stack] must create a feature CodePipeline 1`] = `
Object {
  "Description": "Continous Integration",
  "Resources": Object {
    "ArtifactBucket7410C9EF": Object {
      "DeletionPolicy": "Delete",
      "Properties": Object {
        "BucketEncryption": Object {
          "ServerSideEncryptionConfiguration": Array [
            Object {
              "ServerSideEncryptionByDefault": Object {
                "KMSMasterKeyID": Object {
                  "Fn::GetAtt": Array [
                    "FeatureKMSKeyF1C3E2DD",
                    "Arn",
                  ],
                },
                "SSEAlgorithm": "aws:kms",
              },
            },
          ],
        },
        "BucketName": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-feature-",
              Object {
                "Ref": "AWS::Region",
              },
              "-artifact-bucket",
            ],
          ],
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "feature",
          },
        ],
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Delete",
    },
    "ArtifactBucketPolicy4B4B7752": Object {
      "Properties": Object {
        "Bucket": Object {
          "Ref": "ArtifactBucket7410C9EF",
        },
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "codebuild.amazonaws.com",
              },
              "Resource": Object {
                "Fn::Join": Array [
                  "",
                  Array [
                    Object {
                      "Fn::GetAtt": Array [
                        "ArtifactBucket7410C9EF",
                        "Arn",
                      ],
                    },
                    "/*",
                  ],
                ],
              },
            },
            Object {
              "Action": "s3:*",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "cloudformation.amazonaws.com",
              },
              "Resource": Array [
                Object {
                  "Fn::GetAtt": Array [
                    "ArtifactBucket7410C9EF",
                    "Arn",
                  ],
                },
                Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      Object {
                        "Fn::GetAtt": Array [
                          "ArtifactBucket7410C9EF",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            Object {
              "Action": Array [
                "s3:DeleteObject",
                "s3:GetObject",
                "s3:GetObjectVersion",
                "s3:ListBucket",
                "s3:PutObject",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "Service": "codepipeline.amazonaws.com",
              },
              "Resource": Array [
                Object {
                  "Fn::GetAtt": Array [
                    "ArtifactBucket7410C9EF",
                    "Arn",
                  ],
                },
                Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      Object {
                        "Fn::GetAtt": Array [
                          "ArtifactBucket7410C9EF",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            Object {
              "Action": Array [
                "s3:GetObject",
                "s3:GetObjectVersion",
                "s3:ListBucket",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Array [
                  Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "arn:",
                        Object {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::",
                        Object {
                          "Ref": "AWS::AccountId",
                        },
                        ":root",
                      ],
                    ],
                  },
                  Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "arn:",
                        Object {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::123:root",
                      ],
                    ],
                  },
                  Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "arn:",
                        Object {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::456:root",
                      ],
                    ],
                  },
                  Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "arn:",
                        Object {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::789:root",
                      ],
                    ],
                  },
                ],
              },
              "Resource": Array [
                Object {
                  "Fn::GetAtt": Array [
                    "ArtifactBucket7410C9EF",
                    "Arn",
                  ],
                },
                Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      Object {
                        "Fn::GetAtt": Array [
                          "ArtifactBucket7410C9EF",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            Object {
              "Action": "s3:PutObject",
              "Condition": Object {
                "Null": Object {
                  "s3:x-amz-server-side-encryption": "true",
                },
              },
              "Effect": "Deny",
              "Principal": "*",
              "Resource": Array [
                Object {
                  "Fn::GetAtt": Array [
                    "ArtifactBucket7410C9EF",
                    "Arn",
                  ],
                },
                Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      Object {
                        "Fn::GetAtt": Array [
                          "ArtifactBucket7410C9EF",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            Object {
              "Action": "s3:*",
              "Condition": Object {
                "Bool": Object {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": "*",
              "Resource": Array [
                Object {
                  "Fn::GetAtt": Array [
                    "ArtifactBucket7410C9EF",
                    "Arn",
                  ],
                },
                Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      Object {
                        "Fn::GetAtt": Array [
                          "ArtifactBucket7410C9EF",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "CDKBuild7F70D971": Object {
      "Properties": Object {
        "Artifacts": Object {
          "Type": "CODEPIPELINE",
        },
        "EncryptionKey": Object {
          "Fn::GetAtt": Array [
            "FeatureKMSKeyF1C3E2DD",
            "Arn",
          ],
        },
        "Environment": Object {
          "ComputeType": "BUILD_GENERAL1_MEDIUM",
          "Image": "aws/codebuild/standard:3.0",
          "PrivilegedMode": false,
          "Type": "LINUX_CONTAINER",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-feature-",
              Object {
                "Ref": "AWS::Region",
              },
              "-cdk-build",
            ],
          ],
        },
        "ServiceRole": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Source": Object {
          "BuildSpec": "{
  \\"version\\": \\"0.2\\",
  \\"phases\\": {
    \\"install\\": {
      \\"commands\\": [
        \\"npm install -g cdk\\",
        \\"yarn\\"
      ]
    },
    \\"build\\": {
      \\"commands\\": [
        \\"cd $CODEBUILD_SRC_DIR/packages/cdk\\",
        \\"yarn test\\",
        \\"cdk synth Client > client.template.yaml\\",
        \\"cdk synth APILayer > api.template.yaml\\",
        \\"cdk synth Database > database.template.yaml\\"
      ]
    }
  },
  \\"artifacts\\": {
    \\"base-directory\\": \\"$CODEBUILD_SRC_DIR/packages/cdk\\",
    \\"files\\": [
      \\"client.template.yaml\\",
      \\"api.template.yaml\\",
      \\"database.template.yaml\\"
    ]
  },
  \\"reports\\": {
    \\"unit-tests\\": {
      \\"base-directory\\": \\"$CODEBUILD_SRC_DIR/packages/cdk/reports\\",
      \\"files\\": [
        \\"junit.xml\\"
      ]
    }
  }
}",
          "Type": "CODEPIPELINE",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "feature",
          },
        ],
      },
      "Type": "AWS::CodeBuild::Project",
    },
    "DeploymentPipelineEDAF206A": Object {
      "Properties": Object {
        "ArtifactStore": Object {
          "EncryptionKey": Object {
            "Id": Object {
              "Fn::GetAtt": Array [
                "FeatureKMSKeyF1C3E2DD",
                "Arn",
              ],
            },
            "Type": "KMS",
          },
          "Location": Object {
            "Ref": "ArtifactBucket7410C9EF",
          },
          "Type": "S3",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-feature-",
              Object {
                "Ref": "AWS::Region",
              },
              "-deployment-pipeline",
            ],
          ],
        },
        "RestartExecutionOnUpdate": false,
        "RoleArn": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Stages": Array [
          Object {
            "Actions": Array [
              Object {
                "ActionTypeId": Object {
                  "Category": "Source",
                  "Owner": "ThirdParty",
                  "Provider": "GitHub",
                  "Version": "1",
                },
                "Configuration": Object {
                  "Branch": "master",
                  "OAuthToken": "{{resolve:secretsmanager:GitHubToken:SecretString:::}}",
                  "Owner": "AlexBMet",
                  "PollForSourceChanges": false,
                  "Repo": "AlexBCdkRepo",
                },
                "Name": "Source",
                "OutputArtifacts": Array [
                  Object {
                    "Name": "SourceOutput",
                  },
                ],
                "RunOrder": 1,
              },
            ],
            "Name": "Source",
          },
          Object {
            "Actions": Array [
              Object {
                "ActionTypeId": Object {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ProjectName": Object {
                    "Ref": "CDKBuild7F70D971",
                  },
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "SourceOutput",
                  },
                ],
                "Name": "SynthesiseTemplates",
                "OutputArtifacts": Array [
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 1,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ProjectName": Object {
                    "Ref": "LambdaBuildCF1FE7ED",
                  },
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "SourceOutput",
                  },
                ],
                "Name": "BuildLambda",
                "OutputArtifacts": Array [
                  Object {
                    "Name": "LambdaBuildOutput",
                  },
                ],
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 2,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ProjectName": Object {
                    "Ref": "WebsiteBuildD5A80231",
                  },
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "SourceOutput",
                  },
                ],
                "Name": "BuildWebsite",
                "OutputArtifacts": Array [
                  Object {
                    "Name": "WebsiteBuildOutput",
                  },
                ],
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 3,
              },
            ],
            "Name": "Build",
          },
          Object {
            "Actions": Array [
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "ParameterOverrides": "{\\"Environment\\":\\"dev\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"UniquePrefix\\":\\"ghostrider\\"}",
                  "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-database",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::database.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployDatabase",
                "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                "RunOrder": 2,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "Capabilities": "CAPABILITY_NAMED_IAM",
                  "ParameterOverrides": "{\\"Environment\\":\\"dev\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"SourceBucketName\\":{\\"Fn::GetArtifactAtt\\":[\\"LambdaBuildOutput\\",\\"BucketName\\"]},\\"SourceObjectKey\\":{\\"Fn::GetArtifactAtt\\":[\\"LambdaBuildOutput\\",\\"ObjectKey\\"]},\\"UniquePrefix\\":\\"ghostrider\\"}",
                  "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-api-layer",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::api.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "LambdaBuildOutput",
                  },
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployAPILayer",
                "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                "RunOrder": 3,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "ParameterOverrides": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "{\\"Environment\\":\\"dev\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"BucketName\\":\\"ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-dev-website-bucket\\",\\"AccountId\\":\\"123\\",\\"StackAccount\\":\\"",
                        Object {
                          "Ref": "AWS::AccountId",
                        },
                        "\\"}",
                      ],
                    ],
                  },
                  "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-client",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::client.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployClient",
                "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                "RunOrder": 4,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "S3",
                  "Version": "1",
                },
                "Configuration": Object {
                  "BucketName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-dev-website-bucket",
                      ],
                    ],
                  },
                  "Extract": "true",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "WebsiteBuildOutput",
                  },
                ],
                "Name": "DeployWebsite",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 5,
              },
            ],
            "Name": "DeployToDev",
          },
          Object {
            "Actions": Array [
              Object {
                "ActionTypeId": Object {
                  "Category": "Approval",
                  "Owner": "AWS",
                  "Provider": "Manual",
                  "Version": "1",
                },
                "Configuration": Object {
                  "CustomData": "Deploy to the CI environment?",
                },
                "Name": "Approve",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 1,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "ParameterOverrides": "{\\"Environment\\":\\"ci\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"UniquePrefix\\":\\"ghostrider\\"}",
                  "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-database",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::database.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployDatabase",
                "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                "RunOrder": 2,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "Capabilities": "CAPABILITY_NAMED_IAM",
                  "ParameterOverrides": "{\\"Environment\\":\\"ci\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"SourceBucketName\\":{\\"Fn::GetArtifactAtt\\":[\\"LambdaBuildOutput\\",\\"BucketName\\"]},\\"SourceObjectKey\\":{\\"Fn::GetArtifactAtt\\":[\\"LambdaBuildOutput\\",\\"ObjectKey\\"]},\\"UniquePrefix\\":\\"ghostrider\\"}",
                  "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-api-layer",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::api.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "LambdaBuildOutput",
                  },
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployAPILayer",
                "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                "RunOrder": 3,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "ParameterOverrides": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "{\\"Environment\\":\\"ci\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"BucketName\\":\\"ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-ci-website-bucket\\",\\"AccountId\\":\\"456\\",\\"StackAccount\\":\\"",
                        Object {
                          "Ref": "AWS::AccountId",
                        },
                        "\\"}",
                      ],
                    ],
                  },
                  "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-client",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::client.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployClient",
                "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                "RunOrder": 4,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "S3",
                  "Version": "1",
                },
                "Configuration": Object {
                  "BucketName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-ci-website-bucket",
                      ],
                    ],
                  },
                  "Extract": "true",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "WebsiteBuildOutput",
                  },
                ],
                "Name": "DeployWebsite",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 5,
              },
            ],
            "Name": "DeployToCI",
          },
          Object {
            "Actions": Array [
              Object {
                "ActionTypeId": Object {
                  "Category": "Approval",
                  "Owner": "AWS",
                  "Provider": "Manual",
                  "Version": "1",
                },
                "Configuration": Object {
                  "CustomData": "Teardown the ci environment?",
                },
                "Name": "Approve",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 1,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1",
                },
                "Configuration": Object {
                  "EnvironmentVariables": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "[{\\"name\\":\\"BUCKET_NAME\\",\\"type\\":\\"PLAINTEXT\\",\\"value\\":\\"ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-ci-website-bucket\\"},{\\"name\\":\\"AWS_ACCOUNT\\",\\"type\\":\\"PLAINTEXT\\",\\"value\\":\\"456\\"}]",
                      ],
                    ],
                  },
                  "ProjectName": Object {
                    "Ref": "EmptyCiBucketBuild88DB8EF6",
                  },
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "SourceOutput",
                  },
                ],
                "Name": "EmptyCiBucket",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 2,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "DELETE_ONLY",
                  "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-client",
                      ],
                    ],
                  },
                },
                "Name": "TeardownClient",
                "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                "RunOrder": 3,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "DELETE_ONLY",
                  "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-api-layer",
                      ],
                    ],
                  },
                },
                "Name": "TeardownAPILayer",
                "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                "RunOrder": 4,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "DELETE_ONLY",
                  "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-database",
                      ],
                    ],
                  },
                },
                "Name": "TeardownDatabase",
                "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                "RunOrder": 5,
              },
            ],
            "Name": "CITeardown",
          },
          Object {
            "Actions": Array [
              Object {
                "ActionTypeId": Object {
                  "Category": "Approval",
                  "Owner": "AWS",
                  "Provider": "Manual",
                  "Version": "1",
                },
                "Configuration": Object {
                  "CustomData": "Teardown the dev environment?",
                },
                "Name": "Approve",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 1,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1",
                },
                "Configuration": Object {
                  "EnvironmentVariables": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "[{\\"name\\":\\"BUCKET_NAME\\",\\"type\\":\\"PLAINTEXT\\",\\"value\\":\\"ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-dev-website-bucket\\"},{\\"name\\":\\"AWS_ACCOUNT\\",\\"type\\":\\"PLAINTEXT\\",\\"value\\":\\"123\\"}]",
                      ],
                    ],
                  },
                  "ProjectName": Object {
                    "Ref": "EmptyDevBucketBuild5979A143",
                  },
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "SourceOutput",
                  },
                ],
                "Name": "EmptyDevBucket",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 2,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "DELETE_ONLY",
                  "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-client",
                      ],
                    ],
                  },
                },
                "Name": "TeardownClient",
                "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                "RunOrder": 3,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "DELETE_ONLY",
                  "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-api-layer",
                      ],
                    ],
                  },
                },
                "Name": "TeardownAPILayer",
                "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                "RunOrder": 4,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "DELETE_ONLY",
                  "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-feature-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-database",
                      ],
                    ],
                  },
                },
                "Name": "TeardownDatabase",
                "RoleArn": "arn:aws:iam::123:role/PipelineAutomationRole",
                "RunOrder": 5,
              },
            ],
            "Name": "DevTeardown",
          },
        ],
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "feature",
          },
        ],
      },
      "Type": "AWS::CodePipeline::Pipeline",
    },
    "DeploymentPipelineSourceWebhookResource70374C7A": Object {
      "Properties": Object {
        "Authentication": "GITHUB_HMAC",
        "AuthenticationConfiguration": Object {
          "SecretToken": "{{resolve:secretsmanager:GitHubToken:SecretString:::}}",
        },
        "Filters": Array [
          Object {
            "JsonPath": "$.ref",
            "MatchEquals": "refs/heads/{Branch}",
          },
        ],
        "RegisterWithThirdParty": true,
        "TargetAction": "Source",
        "TargetPipeline": Object {
          "Ref": "DeploymentPipelineEDAF206A",
        },
        "TargetPipelineVersion": 1,
      },
      "Type": "AWS::CodePipeline::Webhook",
    },
    "EmptyCiBucketBuild88DB8EF6": Object {
      "Properties": Object {
        "Artifacts": Object {
          "Type": "CODEPIPELINE",
        },
        "EncryptionKey": Object {
          "Fn::GetAtt": Array [
            "FeatureKMSKeyF1C3E2DD",
            "Arn",
          ],
        },
        "Environment": Object {
          "ComputeType": "BUILD_GENERAL1_SMALL",
          "Image": "aws/codebuild/standard:1.0",
          "PrivilegedMode": false,
          "Type": "LINUX_CONTAINER",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-feature-",
              Object {
                "Ref": "AWS::Region",
              },
              "-ci-empty-bucket-build",
            ],
          ],
        },
        "ServiceRole": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Source": Object {
          "BuildSpec": "{
  \\"version\\": \\"0.2\\",
  \\"phases\\": {
    \\"install\\": {
      \\"commands\\": [
        \\"apt-get update\\",
        \\"apt-get -y install jq\\",
        \\"apt-get -y install python3-pip\\",
        \\"pip3 install awscli --upgrade\\"
      ]
    },
    \\"build\\": {
      \\"commands\\": [
        \\"echo Assuming PipelineAutomationRole to empty buckets\\",
        \\"TEMP_ROLE=$(aws sts assume-role --role-arn arn:aws:iam::\${AWS_ACCOUNT}:role/PipelineAutomationRole --role-session-name AssumePipelineAutomationRole)\\",
        \\"AKID=$(echo $TEMP_ROLE | jq -r '.Credentials.AccessKeyId')\\",
        \\"SAK=$(echo $TEMP_ROLE | jq -r '.Credentials.SecretAccessKey')\\",
        \\"ST=$(echo $TEMP_ROLE | jq -r '.Credentials.SessionToken')\\",
        \\"aws configure set aws_access_key_id $AKID \\",
        \\"aws configure set aws_secret_access_key $SAK\\",
        \\"aws configure set aws_session_token $ST\\",
        \\"aws s3 rm s3://\${BUCKET_NAME} --recursive\\"
      ]
    }
  }
}",
          "Type": "CODEPIPELINE",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "feature",
          },
        ],
      },
      "Type": "AWS::CodeBuild::Project",
    },
    "EmptyDevBucketBuild5979A143": Object {
      "Properties": Object {
        "Artifacts": Object {
          "Type": "CODEPIPELINE",
        },
        "EncryptionKey": Object {
          "Fn::GetAtt": Array [
            "FeatureKMSKeyF1C3E2DD",
            "Arn",
          ],
        },
        "Environment": Object {
          "ComputeType": "BUILD_GENERAL1_SMALL",
          "Image": "aws/codebuild/standard:1.0",
          "PrivilegedMode": false,
          "Type": "LINUX_CONTAINER",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-feature-",
              Object {
                "Ref": "AWS::Region",
              },
              "-empty-dev-bucket-build",
            ],
          ],
        },
        "ServiceRole": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Source": Object {
          "BuildSpec": "{
  \\"version\\": \\"0.2\\",
  \\"phases\\": {
    \\"install\\": {
      \\"commands\\": [
        \\"apt-get update\\",
        \\"apt-get -y install jq\\",
        \\"apt-get -y install python3-pip\\",
        \\"pip3 install awscli --upgrade\\"
      ]
    },
    \\"build\\": {
      \\"commands\\": [
        \\"echo Assuming PipelineAutomationRole to empty buckets\\",
        \\"TEMP_ROLE=$(aws sts assume-role --role-arn arn:aws:iam::\${AWS_ACCOUNT}:role/PipelineAutomationRole --role-session-name AssumePipelineAutomationRole)\\",
        \\"AKID=$(echo $TEMP_ROLE | jq -r '.Credentials.AccessKeyId')\\",
        \\"SAK=$(echo $TEMP_ROLE | jq -r '.Credentials.SecretAccessKey')\\",
        \\"ST=$(echo $TEMP_ROLE | jq -r '.Credentials.SessionToken')\\",
        \\"aws configure set aws_access_key_id $AKID \\",
        \\"aws configure set aws_secret_access_key $SAK\\",
        \\"aws configure set aws_session_token $ST\\",
        \\"aws s3 rm s3://\${BUCKET_NAME} --recursive\\"
      ]
    }
  }
}",
          "Type": "CODEPIPELINE",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "feature",
          },
        ],
      },
      "Type": "AWS::CodeBuild::Project",
    },
    "FeatureKMSKeyAlias7ACEBE30": Object {
      "Properties": Object {
        "AliasName": Object {
          "Fn::Join": Array [
            "",
            Array [
              "alias/ghostrider/",
              Object {
                "Ref": "AWS::Region",
              },
              "/feature/key",
            ],
          ],
        },
        "TargetKeyId": Object {
          "Fn::GetAtt": Array [
            "FeatureKMSKeyF1C3E2DD",
            "Arn",
          ],
        },
      },
      "Type": "AWS::KMS::Alias",
    },
    "FeatureKMSKeyF1C3E2DD": Object {
      "DeletionPolicy": "Delete",
      "Properties": Object {
        "Description": "KMS key for the feature pipeline",
        "EnableKeyRotation": false,
        "KeyPolicy": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "kms:Create*",
                "kms:Describe*",
                "kms:Enable*",
                "kms:List*",
                "kms:Put*",
                "kms:Update*",
                "kms:Revoke*",
                "kms:Disable*",
                "kms:Get*",
                "kms:Delete*",
                "kms:ScheduleKeyDeletion",
                "kms:CancelKeyDeletion",
                "kms:GenerateDataKey",
                "kms:TagResource",
                "kms:UntagResource",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:",
                      Object {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "kms:Decrypt",
                "kms:Encrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "kms:Decrypt",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": "arn:aws:iam::123:role/PipelineAutomationRole",
              },
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "kms:Decrypt",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "kms:Decrypt",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": "arn:aws:iam::456:role/PipelineAutomationRole",
              },
              "Resource": "*",
            },
          ],
          "Version": "2012-10-17",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "feature",
          },
        ],
      },
      "Type": "AWS::KMS::Key",
      "UpdateReplacePolicy": "Delete",
    },
    "LambdaBuildCF1FE7ED": Object {
      "Properties": Object {
        "Artifacts": Object {
          "Type": "CODEPIPELINE",
        },
        "EncryptionKey": Object {
          "Fn::GetAtt": Array [
            "FeatureKMSKeyF1C3E2DD",
            "Arn",
          ],
        },
        "Environment": Object {
          "ComputeType": "BUILD_GENERAL1_MEDIUM",
          "Image": "aws/codebuild/standard:3.0",
          "PrivilegedMode": false,
          "Type": "LINUX_CONTAINER",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-feature-",
              Object {
                "Ref": "AWS::Region",
              },
              "-lambda-build",
            ],
          ],
        },
        "ServiceRole": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Source": Object {
          "BuildSpec": "{
  \\"version\\": \\"0.2\\",
  \\"phases\\": {
    \\"install\\": {
      \\"commands\\": [
        \\"yarn\\"
      ]
    },
    \\"build\\": {
      \\"commands\\": [
        \\"cd $CODEBUILD_SRC_DIR/packages/lambda\\",
        \\"yarn test\\",
        \\"yarn build\\",
        \\"cd $CODEBUILD_SRC_DIR\\",
        \\"yarn install --production --ignore-scripts --prefer-offline\\"
      ]
    }
  },
  \\"artifacts\\": {
    \\"base-directory\\": \\"$CODEBUILD_SRC_DIR/packages/lambda\\",
    \\"files\\": [
      \\"dist/*\\",
      \\"node_modules/*\\"
    ]
  },
  \\"reports\\": {
    \\"unit-tests\\": {
      \\"base-directory\\": \\"$CODEBUILD_SRC_DIR/packages/lambda/reports\\",
      \\"files\\": [
        \\"junit.xml\\"
      ]
    }
  }
}",
          "Type": "CODEPIPELINE",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "feature",
          },
        ],
      },
      "Type": "AWS::CodeBuild::Project",
    },
    "WebsiteBuildD5A80231": Object {
      "Properties": Object {
        "Artifacts": Object {
          "Type": "CODEPIPELINE",
        },
        "EncryptionKey": Object {
          "Fn::GetAtt": Array [
            "FeatureKMSKeyF1C3E2DD",
            "Arn",
          ],
        },
        "Environment": Object {
          "ComputeType": "BUILD_GENERAL1_MEDIUM",
          "Image": "aws/codebuild/standard:3.0",
          "PrivilegedMode": false,
          "Type": "LINUX_CONTAINER",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-feature-",
              Object {
                "Ref": "AWS::Region",
              },
              "-website-build",
            ],
          ],
        },
        "ServiceRole": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Source": Object {
          "BuildSpec": "{
  \\"version\\": \\"0.2\\",
  \\"artifacts\\": {
    \\"base-directory\\": \\"$CODEBUILD_SRC_DIR/packages/website\\",
    \\"files\\": [
      \\"index.html\\"
    ]
  }
}",
          "Type": "CODEPIPELINE",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "feature",
          },
        ],
      },
      "Type": "AWS::CodeBuild::Project",
    },
  },
}
`;

exports[`[deployment-pipeline.ts] unit tests [stack] must create a release CodePipeline 1`] = `
Object {
  "Description": "Continous Integration",
  "Resources": Object {
    "ArtifactBucket7410C9EF": Object {
      "DeletionPolicy": "Delete",
      "Properties": Object {
        "BucketEncryption": Object {
          "ServerSideEncryptionConfiguration": Array [
            Object {
              "ServerSideEncryptionByDefault": Object {
                "KMSMasterKeyID": Object {
                  "Fn::GetAtt": Array [
                    "FeatureKMSKeyF1C3E2DD",
                    "Arn",
                  ],
                },
                "SSEAlgorithm": "aws:kms",
              },
            },
          ],
        },
        "BucketName": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-release-",
              Object {
                "Ref": "AWS::Region",
              },
              "-artifact-bucket",
            ],
          ],
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "release",
          },
        ],
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Delete",
    },
    "ArtifactBucketPolicy4B4B7752": Object {
      "Properties": Object {
        "Bucket": Object {
          "Ref": "ArtifactBucket7410C9EF",
        },
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "codebuild.amazonaws.com",
              },
              "Resource": Object {
                "Fn::Join": Array [
                  "",
                  Array [
                    Object {
                      "Fn::GetAtt": Array [
                        "ArtifactBucket7410C9EF",
                        "Arn",
                      ],
                    },
                    "/*",
                  ],
                ],
              },
            },
            Object {
              "Action": "s3:*",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "cloudformation.amazonaws.com",
              },
              "Resource": Array [
                Object {
                  "Fn::GetAtt": Array [
                    "ArtifactBucket7410C9EF",
                    "Arn",
                  ],
                },
                Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      Object {
                        "Fn::GetAtt": Array [
                          "ArtifactBucket7410C9EF",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            Object {
              "Action": Array [
                "s3:DeleteObject",
                "s3:GetObject",
                "s3:GetObjectVersion",
                "s3:ListBucket",
                "s3:PutObject",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "Service": "codepipeline.amazonaws.com",
              },
              "Resource": Array [
                Object {
                  "Fn::GetAtt": Array [
                    "ArtifactBucket7410C9EF",
                    "Arn",
                  ],
                },
                Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      Object {
                        "Fn::GetAtt": Array [
                          "ArtifactBucket7410C9EF",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            Object {
              "Action": Array [
                "s3:GetObject",
                "s3:GetObjectVersion",
                "s3:ListBucket",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Array [
                  Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "arn:",
                        Object {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::",
                        Object {
                          "Ref": "AWS::AccountId",
                        },
                        ":root",
                      ],
                    ],
                  },
                  Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "arn:",
                        Object {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::123:root",
                      ],
                    ],
                  },
                  Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "arn:",
                        Object {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::456:root",
                      ],
                    ],
                  },
                  Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "arn:",
                        Object {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::789:root",
                      ],
                    ],
                  },
                ],
              },
              "Resource": Array [
                Object {
                  "Fn::GetAtt": Array [
                    "ArtifactBucket7410C9EF",
                    "Arn",
                  ],
                },
                Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      Object {
                        "Fn::GetAtt": Array [
                          "ArtifactBucket7410C9EF",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            Object {
              "Action": "s3:PutObject",
              "Condition": Object {
                "Null": Object {
                  "s3:x-amz-server-side-encryption": "true",
                },
              },
              "Effect": "Deny",
              "Principal": "*",
              "Resource": Array [
                Object {
                  "Fn::GetAtt": Array [
                    "ArtifactBucket7410C9EF",
                    "Arn",
                  ],
                },
                Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      Object {
                        "Fn::GetAtt": Array [
                          "ArtifactBucket7410C9EF",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            Object {
              "Action": "s3:*",
              "Condition": Object {
                "Bool": Object {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": "*",
              "Resource": Array [
                Object {
                  "Fn::GetAtt": Array [
                    "ArtifactBucket7410C9EF",
                    "Arn",
                  ],
                },
                Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      Object {
                        "Fn::GetAtt": Array [
                          "ArtifactBucket7410C9EF",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "CDKBuild7F70D971": Object {
      "Properties": Object {
        "Artifacts": Object {
          "Type": "CODEPIPELINE",
        },
        "EncryptionKey": Object {
          "Fn::GetAtt": Array [
            "FeatureKMSKeyF1C3E2DD",
            "Arn",
          ],
        },
        "Environment": Object {
          "ComputeType": "BUILD_GENERAL1_MEDIUM",
          "Image": "aws/codebuild/standard:3.0",
          "PrivilegedMode": false,
          "Type": "LINUX_CONTAINER",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-release-",
              Object {
                "Ref": "AWS::Region",
              },
              "-cdk-build",
            ],
          ],
        },
        "ServiceRole": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Source": Object {
          "BuildSpec": "{
  \\"version\\": \\"0.2\\",
  \\"phases\\": {
    \\"install\\": {
      \\"commands\\": [
        \\"npm install -g cdk\\",
        \\"yarn\\"
      ]
    },
    \\"build\\": {
      \\"commands\\": [
        \\"cd $CODEBUILD_SRC_DIR/packages/cdk\\",
        \\"yarn test\\",
        \\"cdk synth Client > client.template.yaml\\",
        \\"cdk synth APILayer > api.template.yaml\\",
        \\"cdk synth Database > database.template.yaml\\"
      ]
    }
  },
  \\"artifacts\\": {
    \\"base-directory\\": \\"$CODEBUILD_SRC_DIR/packages/cdk\\",
    \\"files\\": [
      \\"client.template.yaml\\",
      \\"api.template.yaml\\",
      \\"database.template.yaml\\"
    ]
  },
  \\"reports\\": {
    \\"unit-tests\\": {
      \\"base-directory\\": \\"$CODEBUILD_SRC_DIR/packages/cdk/reports\\",
      \\"files\\": [
        \\"junit.xml\\"
      ]
    }
  }
}",
          "Type": "CODEPIPELINE",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "release",
          },
        ],
      },
      "Type": "AWS::CodeBuild::Project",
    },
    "DeploymentPipelineEDAF206A": Object {
      "Properties": Object {
        "ArtifactStore": Object {
          "EncryptionKey": Object {
            "Id": Object {
              "Fn::GetAtt": Array [
                "FeatureKMSKeyF1C3E2DD",
                "Arn",
              ],
            },
            "Type": "KMS",
          },
          "Location": Object {
            "Ref": "ArtifactBucket7410C9EF",
          },
          "Type": "S3",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-release-",
              Object {
                "Ref": "AWS::Region",
              },
              "-deployment-pipeline",
            ],
          ],
        },
        "RestartExecutionOnUpdate": false,
        "RoleArn": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Stages": Array [
          Object {
            "Actions": Array [
              Object {
                "ActionTypeId": Object {
                  "Category": "Source",
                  "Owner": "ThirdParty",
                  "Provider": "GitHub",
                  "Version": "1",
                },
                "Configuration": Object {
                  "Branch": "master",
                  "OAuthToken": "{{resolve:secretsmanager:GitHubToken:SecretString:::}}",
                  "Owner": "AlexBMet",
                  "PollForSourceChanges": false,
                  "Repo": "AlexBCdkRepo",
                },
                "Name": "Source",
                "OutputArtifacts": Array [
                  Object {
                    "Name": "SourceOutput",
                  },
                ],
                "RunOrder": 1,
              },
            ],
            "Name": "Source",
          },
          Object {
            "Actions": Array [
              Object {
                "ActionTypeId": Object {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ProjectName": Object {
                    "Ref": "CDKBuild7F70D971",
                  },
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "SourceOutput",
                  },
                ],
                "Name": "SynthesiseTemplates",
                "OutputArtifacts": Array [
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 1,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ProjectName": Object {
                    "Ref": "LambdaBuildCF1FE7ED",
                  },
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "SourceOutput",
                  },
                ],
                "Name": "BuildLambda",
                "OutputArtifacts": Array [
                  Object {
                    "Name": "LambdaBuildOutput",
                  },
                ],
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 2,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ProjectName": Object {
                    "Ref": "WebsiteBuildD5A80231",
                  },
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "SourceOutput",
                  },
                ],
                "Name": "BuildWebsite",
                "OutputArtifacts": Array [
                  Object {
                    "Name": "WebsiteBuildOutput",
                  },
                ],
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 3,
              },
            ],
            "Name": "Build",
          },
          Object {
            "Actions": Array [
              Object {
                "ActionTypeId": Object {
                  "Category": "Approval",
                  "Owner": "AWS",
                  "Provider": "Manual",
                  "Version": "1",
                },
                "Configuration": Object {
                  "CustomData": "Deploy to the staging environment?",
                },
                "Name": "Approve",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 1,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "ParameterOverrides": "{\\"Environment\\":\\"stg\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"UniquePrefix\\":\\"ghostrider\\"}",
                  "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-release-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-database",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::database.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployDatabase",
                "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                "RunOrder": 2,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "Capabilities": "CAPABILITY_NAMED_IAM",
                  "ParameterOverrides": "{\\"Environment\\":\\"stg\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"SourceBucketName\\":{\\"Fn::GetArtifactAtt\\":[\\"LambdaBuildOutput\\",\\"BucketName\\"]},\\"SourceObjectKey\\":{\\"Fn::GetArtifactAtt\\":[\\"LambdaBuildOutput\\",\\"ObjectKey\\"]},\\"UniquePrefix\\":\\"ghostrider\\"}",
                  "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-release-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-api-layer",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::api.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "LambdaBuildOutput",
                  },
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployAPILayer",
                "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                "RunOrder": 3,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "ParameterOverrides": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "{\\"Environment\\":\\"stg\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"BucketName\\":\\"ghostrider-release-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-stg-website-bucket\\",\\"AccountId\\":\\"456\\",\\"StackAccount\\":\\"",
                        Object {
                          "Ref": "AWS::AccountId",
                        },
                        "\\"}",
                      ],
                    ],
                  },
                  "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-release-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-client",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::client.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployClient",
                "RoleArn": "arn:aws:iam::456:role/PipelineAutomationRole",
                "RunOrder": 4,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "S3",
                  "Version": "1",
                },
                "Configuration": Object {
                  "BucketName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-release-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-stg-website-bucket",
                      ],
                    ],
                  },
                  "Extract": "true",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "WebsiteBuildOutput",
                  },
                ],
                "Name": "DeployWebsite",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 5,
              },
            ],
            "Name": "DeployToStg",
          },
          Object {
            "Actions": Array [
              Object {
                "ActionTypeId": Object {
                  "Category": "Approval",
                  "Owner": "AWS",
                  "Provider": "Manual",
                  "Version": "1",
                },
                "Configuration": Object {
                  "CustomData": "Deploy to the production environment?",
                },
                "Name": "Approve",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 1,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "ParameterOverrides": "{\\"Environment\\":\\"prod\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"UniquePrefix\\":\\"ghostrider\\"}",
                  "RoleArn": "arn:aws:iam::789:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-release-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-database",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::database.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployDatabase",
                "RoleArn": "arn:aws:iam::789:role/PipelineAutomationRole",
                "RunOrder": 2,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "Capabilities": "CAPABILITY_NAMED_IAM",
                  "ParameterOverrides": "{\\"Environment\\":\\"prod\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"SourceBucketName\\":{\\"Fn::GetArtifactAtt\\":[\\"LambdaBuildOutput\\",\\"BucketName\\"]},\\"SourceObjectKey\\":{\\"Fn::GetArtifactAtt\\":[\\"LambdaBuildOutput\\",\\"ObjectKey\\"]},\\"UniquePrefix\\":\\"ghostrider\\"}",
                  "RoleArn": "arn:aws:iam::789:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-release-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-api-layer",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::api.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "LambdaBuildOutput",
                  },
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployAPILayer",
                "RoleArn": "arn:aws:iam::789:role/PipelineAutomationRole",
                "RunOrder": 3,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1",
                },
                "Configuration": Object {
                  "ActionMode": "CREATE_UPDATE",
                  "ParameterOverrides": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "{\\"Environment\\":\\"prod\\",\\"ServiceCode\\":\\"SFWRMC\\",\\"ServiceName\\":\\"NSWWS Sign Up\\",\\"ServiceOwner\\":\\"aws-nswws-dis-business@metoffice.gov.uk\\",\\"BucketName\\":\\"ghostrider-release-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-prod-website-bucket\\",\\"AccountId\\":\\"789\\",\\"StackAccount\\":\\"",
                        Object {
                          "Ref": "AWS::AccountId",
                        },
                        "\\"}",
                      ],
                    ],
                  },
                  "RoleArn": "arn:aws:iam::789:role/PipelineAutomationRole",
                  "StackName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-release-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-client",
                      ],
                    ],
                  },
                  "TemplatePath": "CDKBuildOutput::client.template.yaml",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "CDKBuildOutput",
                  },
                ],
                "Name": "DeployClient",
                "RoleArn": "arn:aws:iam::789:role/PipelineAutomationRole",
                "RunOrder": 4,
              },
              Object {
                "ActionTypeId": Object {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "S3",
                  "Version": "1",
                },
                "Configuration": Object {
                  "BucketName": Object {
                    "Fn::Join": Array [
                      "",
                      Array [
                        "ghostrider-release-",
                        Object {
                          "Ref": "AWS::Region",
                        },
                        "-prod-website-bucket",
                      ],
                    ],
                  },
                  "Extract": "true",
                },
                "InputArtifacts": Array [
                  Object {
                    "Name": "WebsiteBuildOutput",
                  },
                ],
                "Name": "DeployWebsite",
                "RoleArn": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
                "RunOrder": 5,
              },
            ],
            "Name": "DeployToProd",
          },
        ],
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "release",
          },
        ],
      },
      "Type": "AWS::CodePipeline::Pipeline",
    },
    "DeploymentPipelineSourceWebhookResource70374C7A": Object {
      "Properties": Object {
        "Authentication": "GITHUB_HMAC",
        "AuthenticationConfiguration": Object {
          "SecretToken": "{{resolve:secretsmanager:GitHubToken:SecretString:::}}",
        },
        "Filters": Array [
          Object {
            "JsonPath": "$.ref",
            "MatchEquals": "refs/heads/{Branch}",
          },
        ],
        "RegisterWithThirdParty": true,
        "TargetAction": "Source",
        "TargetPipeline": Object {
          "Ref": "DeploymentPipelineEDAF206A",
        },
        "TargetPipelineVersion": 1,
      },
      "Type": "AWS::CodePipeline::Webhook",
    },
    "EmptyCiBucketBuild88DB8EF6": Object {
      "Properties": Object {
        "Artifacts": Object {
          "Type": "CODEPIPELINE",
        },
        "Environment": Object {
          "ComputeType": "BUILD_GENERAL1_SMALL",
          "Image": "aws/codebuild/standard:1.0",
          "PrivilegedMode": false,
          "Type": "LINUX_CONTAINER",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-release-",
              Object {
                "Ref": "AWS::Region",
              },
              "-ci-empty-bucket-build",
            ],
          ],
        },
        "ServiceRole": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Source": Object {
          "BuildSpec": "{
  \\"version\\": \\"0.2\\",
  \\"phases\\": {
    \\"install\\": {
      \\"commands\\": [
        \\"apt-get update\\",
        \\"apt-get -y install jq\\",
        \\"apt-get -y install python3-pip\\",
        \\"pip3 install awscli --upgrade\\"
      ]
    },
    \\"build\\": {
      \\"commands\\": [
        \\"echo Assuming PipelineAutomationRole to empty buckets\\",
        \\"TEMP_ROLE=$(aws sts assume-role --role-arn arn:aws:iam::\${AWS_ACCOUNT}:role/PipelineAutomationRole --role-session-name AssumePipelineAutomationRole)\\",
        \\"AKID=$(echo $TEMP_ROLE | jq -r '.Credentials.AccessKeyId')\\",
        \\"SAK=$(echo $TEMP_ROLE | jq -r '.Credentials.SecretAccessKey')\\",
        \\"ST=$(echo $TEMP_ROLE | jq -r '.Credentials.SessionToken')\\",
        \\"aws configure set aws_access_key_id $AKID \\",
        \\"aws configure set aws_secret_access_key $SAK\\",
        \\"aws configure set aws_session_token $ST\\",
        \\"aws s3 rm s3://\${BUCKET_NAME} --recursive\\"
      ]
    }
  }
}",
          "Type": "CODEPIPELINE",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "release",
          },
        ],
      },
      "Type": "AWS::CodeBuild::Project",
    },
    "EmptyDevBucketBuild5979A143": Object {
      "Properties": Object {
        "Artifacts": Object {
          "Type": "CODEPIPELINE",
        },
        "Environment": Object {
          "ComputeType": "BUILD_GENERAL1_SMALL",
          "Image": "aws/codebuild/standard:1.0",
          "PrivilegedMode": false,
          "Type": "LINUX_CONTAINER",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-release-",
              Object {
                "Ref": "AWS::Region",
              },
              "-empty-dev-bucket-build",
            ],
          ],
        },
        "ServiceRole": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Source": Object {
          "BuildSpec": "{
  \\"version\\": \\"0.2\\",
  \\"phases\\": {
    \\"install\\": {
      \\"commands\\": [
        \\"apt-get update\\",
        \\"apt-get -y install jq\\",
        \\"apt-get -y install python3-pip\\",
        \\"pip3 install awscli --upgrade\\"
      ]
    },
    \\"build\\": {
      \\"commands\\": [
        \\"echo Assuming PipelineAutomationRole to empty buckets\\",
        \\"TEMP_ROLE=$(aws sts assume-role --role-arn arn:aws:iam::\${AWS_ACCOUNT}:role/PipelineAutomationRole --role-session-name AssumePipelineAutomationRole)\\",
        \\"AKID=$(echo $TEMP_ROLE | jq -r '.Credentials.AccessKeyId')\\",
        \\"SAK=$(echo $TEMP_ROLE | jq -r '.Credentials.SecretAccessKey')\\",
        \\"ST=$(echo $TEMP_ROLE | jq -r '.Credentials.SessionToken')\\",
        \\"aws configure set aws_access_key_id $AKID \\",
        \\"aws configure set aws_secret_access_key $SAK\\",
        \\"aws configure set aws_session_token $ST\\",
        \\"aws s3 rm s3://\${BUCKET_NAME} --recursive\\"
      ]
    }
  }
}",
          "Type": "CODEPIPELINE",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "release",
          },
        ],
      },
      "Type": "AWS::CodeBuild::Project",
    },
    "FeatureKMSKeyAlias7ACEBE30": Object {
      "Properties": Object {
        "AliasName": Object {
          "Fn::Join": Array [
            "",
            Array [
              "alias/ghostrider/",
              Object {
                "Ref": "AWS::Region",
              },
              "/release/key",
            ],
          ],
        },
        "TargetKeyId": Object {
          "Fn::GetAtt": Array [
            "FeatureKMSKeyF1C3E2DD",
            "Arn",
          ],
        },
      },
      "Type": "AWS::KMS::Alias",
    },
    "FeatureKMSKeyF1C3E2DD": Object {
      "DeletionPolicy": "Delete",
      "Properties": Object {
        "Description": "KMS key for the release pipeline",
        "EnableKeyRotation": false,
        "KeyPolicy": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "kms:Create*",
                "kms:Describe*",
                "kms:Enable*",
                "kms:List*",
                "kms:Put*",
                "kms:Update*",
                "kms:Revoke*",
                "kms:Disable*",
                "kms:Get*",
                "kms:Delete*",
                "kms:ScheduleKeyDeletion",
                "kms:CancelKeyDeletion",
                "kms:GenerateDataKey",
                "kms:TagResource",
                "kms:UntagResource",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:",
                      Object {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "kms:Decrypt",
                "kms:Encrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "kms:Decrypt",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": "arn:aws:iam::456:role/PipelineAutomationRole",
              },
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "kms:Decrypt",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:aws:iam::",
                      Object {
                        "Ref": "AWS::AccountId",
                      },
                      ":role/PipelineAutomationRole",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "kms:Decrypt",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": Object {
                "AWS": "arn:aws:iam::789:role/PipelineAutomationRole",
              },
              "Resource": "*",
            },
          ],
          "Version": "2012-10-17",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "release",
          },
        ],
      },
      "Type": "AWS::KMS::Key",
      "UpdateReplacePolicy": "Delete",
    },
    "LambdaBuildCF1FE7ED": Object {
      "Properties": Object {
        "Artifacts": Object {
          "Type": "CODEPIPELINE",
        },
        "EncryptionKey": Object {
          "Fn::GetAtt": Array [
            "FeatureKMSKeyF1C3E2DD",
            "Arn",
          ],
        },
        "Environment": Object {
          "ComputeType": "BUILD_GENERAL1_MEDIUM",
          "Image": "aws/codebuild/standard:3.0",
          "PrivilegedMode": false,
          "Type": "LINUX_CONTAINER",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-release-",
              Object {
                "Ref": "AWS::Region",
              },
              "-lambda-build",
            ],
          ],
        },
        "ServiceRole": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Source": Object {
          "BuildSpec": "{
  \\"version\\": \\"0.2\\",
  \\"phases\\": {
    \\"install\\": {
      \\"commands\\": [
        \\"yarn\\"
      ]
    },
    \\"build\\": {
      \\"commands\\": [
        \\"cd $CODEBUILD_SRC_DIR/packages/lambda\\",
        \\"yarn test\\",
        \\"yarn build\\",
        \\"cd $CODEBUILD_SRC_DIR\\",
        \\"yarn install --production --ignore-scripts --prefer-offline\\"
      ]
    }
  },
  \\"artifacts\\": {
    \\"base-directory\\": \\"$CODEBUILD_SRC_DIR/packages/lambda\\",
    \\"files\\": [
      \\"dist/*\\",
      \\"node_modules/*\\"
    ]
  },
  \\"reports\\": {
    \\"unit-tests\\": {
      \\"base-directory\\": \\"$CODEBUILD_SRC_DIR/packages/lambda/reports\\",
      \\"files\\": [
        \\"junit.xml\\"
      ]
    }
  }
}",
          "Type": "CODEPIPELINE",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "release",
          },
        ],
      },
      "Type": "AWS::CodeBuild::Project",
    },
    "WebsiteBuildD5A80231": Object {
      "Properties": Object {
        "Artifacts": Object {
          "Type": "CODEPIPELINE",
        },
        "EncryptionKey": Object {
          "Fn::GetAtt": Array [
            "FeatureKMSKeyF1C3E2DD",
            "Arn",
          ],
        },
        "Environment": Object {
          "ComputeType": "BUILD_GENERAL1_MEDIUM",
          "Image": "aws/codebuild/standard:3.0",
          "PrivilegedMode": false,
          "Type": "LINUX_CONTAINER",
        },
        "Name": Object {
          "Fn::Join": Array [
            "",
            Array [
              "ghostrider-release-",
              Object {
                "Ref": "AWS::Region",
              },
              "-website-build",
            ],
          ],
        },
        "ServiceRole": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:aws:iam::",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":role/PipelineAutomationRole",
            ],
          ],
        },
        "Source": Object {
          "BuildSpec": "{
  \\"version\\": \\"0.2\\",
  \\"artifacts\\": {
    \\"base-directory\\": \\"$CODEBUILD_SRC_DIR/packages/website\\",
    \\"files\\": [
      \\"index.html\\"
    ]
  }
}",
          "Type": "CODEPIPELINE",
        },
        "Tags": Array [
          Object {
            "Key": "Deployment",
            "Value": "release",
          },
        ],
      },
      "Type": "AWS::CodeBuild::Project",
    },
  },
}
`;
